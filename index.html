<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TinZr ECG Viewer (Web)</title>
<style>
  :root{
    --bg:#020817;
    --panel:#0b1220;
    --text:#E3F2FD;
    --muted:#A8B3CF;
    --accent:#5aa7ff;
    --curve:#F5F5F5;
    --danger:#FF5252;
    --dangerFill:#FFCDD2;
    --pill: rgba(0,0,0,0.45);
    --border: rgba(255,255,255,0.10);
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .app{
    width: 600px;
    height: 450px;
    margin: 16px auto;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding: 12px 16px;
    background: transparent;
    border-radius: 16px;
  }
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding-bottom:4px;
  }
  .title{
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
  }
  .battery{
    display:flex; align-items:center; gap:10px;
  }
  .battBtn{
    cursor:pointer;
    user-select:none;
    border:1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    padding:8px 10px;
    border-radius: 12px;
    font-weight: 600;
  }
  .panel{
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 10px;
  }
  .grid{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap:10px;
    align-items:center;
  }
  .row2{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:14px;
    align-items:center;
    margin-top:10px;
  }
  .btn{
    cursor:pointer;
    border:1px solid var(--border);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    padding:10px 12px;
    border-radius: 12px;
    font-weight: 700;
  }
  .btn:disabled{
    opacity:0.5; cursor:not-allowed;
  }
  select{
    width:100%;
    border:1px solid var(--border);
    background: rgba(0,0,0,0.22);
    color: var(--text);
    padding:10px 12px;
    border-radius: 12px;
    outline:none;
  }
  .toggleWrap{
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid var(--border);
    background: rgba(0,0,0,0.16);
    padding:10px 12px;
    border-radius: 12px;
  }
  .toggleWrap span{color:var(--text); font-weight:700;}
  .toggle{
    width:46px; height:26px;
    border-radius: 999px;
    background: rgba(255,255,255,0.12);
    border:1px solid var(--border);
    position:relative;
    cursor:pointer;
    flex: 0 0 auto;
  }
  .knob{
    position:absolute; top:3px; left:3px;
    width:20px; height:20px; border-radius:999px;
    background: rgba(255,255,255,0.85);
    transition: transform 120ms ease;
  }
  .toggle.on{ background: rgba(90,167,255,0.35); }
  .toggle.on .knob{ transform: translateX(20px); background: rgba(255,255,255,0.95); }

  .statusRow{
    display:flex; align-items:center; gap:10px; margin-top:10px;
  }
  .status{
    flex:1;
    border:1px solid var(--border);
    background: rgba(0,0,0,0.16);
    border-radius: 12px;
    padding: 10px 12px;
    color: var(--text);
    font-weight: 650;
  }

  .plotWrap{
    position:relative;
    flex:1;
    background: var(--bg);
    border:1px solid var(--border);
    border-radius: 16px;
    overflow:hidden;
  }
  canvas{ display:block; width:100%; height:100%; }
  .hud{
    position:absolute; right:10px; top:10px;
    background: var(--pill);
    padding:4px 8px;
    border-radius: 10px;
    font-size: 12px;
    color:#fff;
    pointer-events:none;
    white-space:nowrap;
  }
  .foot{
    font-size: 12px;
    color: var(--muted);
    margin-top:4px;
    line-height:1.3;
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">TinZr ECG Viewer</div>
    <div class="battery">
      <button class="battBtn" id="btnBatt">ðŸ”‹ Battery</button>
    </div>
  </div>

  <div class="panel">
    <div class="grid">
      <button class="btn" id="btnScan">Find Devices</button>
      <select id="deviceSelect">
        <option value="">No devices yet</option>
      </select>
    </div>

    <div class="row2">
      <div class="toggleWrap">
        <span>Connect</span>
        <div class="toggle" id="tglConnect"><div class="knob"></div></div>
      </div>
      <div class="toggleWrap">
        <span>Stream ECG</span>
        <div class="toggle" id="tglStream"><div class="knob"></div></div>
      </div>
      <div class="toggleWrap">
        <span>Record</span>
        <div class="toggle" id="tglRecord"><div class="knob"></div></div>
      </div>
    </div>

    <div class="statusRow">
      <button class="btn" id="btnFlip" aria-pressed="false">Flip ECG</button>
      <div class="status" id="status">Status: Idle</div>
    </div>
  </div>

  <div class="plotWrap">
    <div class="hud" id="hud">Fs_out=120.0 Hz | HR: -- bpm</div>
    <canvas id="plot"></canvas>
  </div>

  <div class="foot">
    Notes: Web Bluetooth works on Chrome/Edge (desktop) and Chrome (Android). iPhone Safari doesnâ€™t support Web Bluetooth; use a WebBLE browser (e.g., Bluefy) or a native wrapper.
  </div>
</div>

<script>
/* ================== CONFIG (match your Python) ================== */
const TINZR_BLE_SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const TINZR_BLE_RX_CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const TINZR_BLE_TX_CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a9";

const DEVICE_PREFIX = "TinZr";
const CMD_START = new Uint8Array([ "S".charCodeAt(0) ]);
const CMD_STOP  = new Uint8Array([ "E".charCodeAt(0) ]);
const CMD_BATT  = new Uint8Array([ "B".charCodeAt(0), "A".charCodeAt(0), "T".charCodeAt(0) ]);

// Frame: <iB (little-endian int32 + uint8) => 5 bytes
const FRAME_SIZE = 5;

// Viewer config
const FS_RESAMP_HZ = 120.0;
const WINDOW_SEC = 5.0;
const UPDATE_MS = 10;
const MAX_RAW_SAMPLES = 40000;

/* ================== STATE ================== */
let bleDevice = null;
let gattServer = null;
let rxChar = null;
let txChar = null;

let streaming = false;
let recording = false;

let flipSign = -1.0; // matches your code default
let battPct = null;
let fsEst = null;
let hrBpm = null;

let byteBuf = []; // array of bytes

let sampleCount = 0;
let idxRaw = [];
let ecgRaw = [];

// Calibration
let calibStartTime = null;
let calibStartCount = null;
const CALIB_SAMPLES = Math.floor(4 * FS_RESAMP_HZ);
let calibrating = false;

// Recording buffers (raw; resample on stop)
let recIdxRaw = [];
let recEcgRaw = [];
let recBattRaw = [];

/* ================== UI ================== */
const btnScan = document.getElementById("btnScan");
const deviceSelect = document.getElementById("deviceSelect");
const tglConnect = document.getElementById("tglConnect");
const tglStream = document.getElementById("tglStream");
const tglRecord = document.getElementById("tglRecord");
const btnFlip = document.getElementById("btnFlip");
const btnBatt = document.getElementById("btnBatt");
const statusEl = document.getElementById("status");
const hudEl = document.getElementById("hud");

function setStatus(s){ statusEl.textContent = "Status: " + s; }

function setToggle(el, on){
  el.classList.toggle("on", !!on);
  el.dataset.on = on ? "1" : "0";
}
function getToggle(el){ return el.dataset.on === "1"; }

function enableControls(){
  // connect toggle always enabled if WebBluetooth exists
  tglConnect.style.pointerEvents = navigator.bluetooth ? "auto" : "none";
  tglStream.style.pointerEvents  = (txChar && rxChar) ? "auto" : "none";
  tglRecord.style.pointerEvents  = (txChar && rxChar && streaming) ? "auto" : "none";
  btnScan.disabled = !navigator.bluetooth;
}

function updateHud(){
  let fsText = (fsEst && fsEst > 0) ? `Fs_inâ‰ˆ${fsEst.toFixed(1)} Hz  â†’  Fs_out=${FS_RESAMP_HZ.toFixed(1)} Hz`
                                   : `Fs_out=${FS_RESAMP_HZ.toFixed(1)} Hz`;
  let hrText = (hrBpm && hrBpm > 0) ? `HR: ${Math.round(hrBpm)} bpm` : "HR: -- bpm";
  hudEl.textContent = `${fsText}   |   ${hrText}`;
}

/* ================== PLOT (Canvas) ================== */
const canvas = document.getElementById("plot");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function drawPlot(t, y, peaksIdx){
 
