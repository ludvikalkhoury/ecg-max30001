<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>TinZr ECG Viewer</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#020817">

<style>
:root{
  --bg:#020817;
  --panel:#0b1220;
  --text:#E3F2FD;
  --muted:#A8B3CF;
  --accent:#5aa7ff;
  --curve:#F5F5F5;
  --danger:#FF5252;
  --dangerFill:#FFCDD2;
  --pill: rgba(0,0,0,0.45);
  --border: rgba(255,255,255,0.12);
}

/* ðŸ”´ CRITICAL FIX */
*, *::before, *::after { box-sizing: border-box; }

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  overflow-x:hidden;
}

/* ===== App container ===== */
.app{
  width: min(600px, 100%);
  height: 100vh;
  margin: 0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  padding:
    calc(12px + env(safe-area-inset-top))
    16px
    calc(16px + env(safe-area-inset-bottom))
    16px;
}

/* ===== Header ===== */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.title{
  font-size:22px;
  font-weight:700;
}

.battBtn{
  border:1px solid var(--border);
  background:rgba(255,255,255,0.05);
  color:var(--text);
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
}

/* ===== Panels ===== */
.panel{
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
}

/* ===== Controls ===== */
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}

.row2{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}

.btn{
  border:1px solid var(--border);
  background:rgba(255,255,255,0.06);
  color:var(--text);
  padding:14px;
  border-radius:14px;
  font-weight:900;
}

.selectLike{
  border:1px solid var(--border);
  background:rgba(0,0,0,0.25);
  padding:14px;
  border-radius:14px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* ===== Toggles ===== */
.toggleWrap{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(0,0,0,0.22);
}

.toggle{
  width:52px;
  height:30px;
  border-radius:999px;
  background:rgba(255,255,255,0.2);
  border:1px solid var(--border);
  position:relative;
}

.toggle .knob{
  position:absolute;
  top:3px;
  left:3px;
  width:24px;
  height:24px;
  border-radius:50%;
  background:white;
  transition:transform 120ms ease;
}

.toggle.on{
  background:rgba(90,167,255,0.5);
}

.toggle.on .knob{
  transform:translateX(22px);
}

/* ===== Status ===== */
.status{
  margin-top:10px;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  font-weight:800;
}

/* ===== Plot ===== */
.plotWrap{
  flex:1;
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  position:relative;
}

canvas{ width:100%; height:100%; }

.hud{
  position:absolute;
  top:8px;
  right:8px;
  background:var(--pill);
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
}

/* ===== Footer ===== */
.foot{
  font-size:12px;
  color:var(--muted);
  text-align:center;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">TinZr ECG Viewer</div>
    <button class="battBtn" id="btnBatt">ðŸ”‹ --%</button>
  </div>

  <div class="panel">
    <div class="grid">
      <button class="btn" id="btnFind">Find Devices</button>
      <div class="selectLike" id="selectedDevice">No device selected</div>
    </div>

    <div class="row2" style="margin-top:12px;">
      <div class="toggleWrap">
        <span>Connect</span>
        <div class="toggle" id="tglConnect"><div class="knob"></div></div>
      </div>
      <div class="toggleWrap">
        <span>Stream ECG</span>
        <div class="toggle" id="tglStream"><div class="knob"></div></div>
      </div>
      <div class="toggleWrap">
        <span>Record</span>
        <div class="toggle" id="tglRecord"><div class="knob"></div></div>
      </div>
    </div>

    <button class="btn" id="btnFlip" style="margin-top:12px;">Flip ECG</button>

    <div class="status" id="status">Status: Idle</div>
  </div>

  <div class="plotWrap">
    <div class="hud" id="hud">Fs_out=120 Hz | HR: -- bpm</div>
    <canvas id="plot"></canvas>
  </div>

  <div class="foot">
    iPhone: use Bluefy. iOS uses system BLE picker.
  </div>
</div>

<script>
/* ========= BLE CONFIG ========= */
const SERVICE = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const RX = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const TX = "beb5483e-36e1-4688-b7f5-ea07361b26a9";
const CMD_START = new Uint8Array([83]);
const CMD_STOP  = new Uint8Array([69]);
const CMD_BATT  = new Uint8Array([66,65,84]);

/* ========= STATE ========= */
let device, server, rxChar, txChar;
let battPct = null;

/* ========= UI ========= */
const btnBatt = document.getElementById("btnBatt");
const statusEl = document.getElementById("status");
function setStatus(t){ statusEl.textContent = "Status: " + t; }

/* ========= BATTERY ========= */
btnBatt.onclick = async () => {
  if (!rxChar) return setStatus("Not connected");
  await rxChar.writeValue(CMD_BATT);
  setStatus("Requested battery refresh");
};

/* ========= BLE ========= */
document.getElementById("btnFind").onclick = async () => {
  device = await navigator.bluetooth.requestDevice({
    filters:[{namePrefix:"TinZr"}],
    optionalServices:[SERVICE]
  });
  document.getElementById("selectedDevice").textContent = device.name;
  setStatus("Device selected");
};

document.getElementById("tglConnect").onclick = async e => {
  const on = !e.currentTarget.classList.contains("on");
  if (on){
    server = await device.gatt.connect();
    const svc = await server.getPrimaryService(SERVICE);
    rxChar = await svc.getCharacteristic(RX);
    txChar = await svc.getCharacteristic(TX);
    await txChar.startNotifications();
    txChar.oncharacteristicvaluechanged = ev => {
      const v = ev.target.value;
      battPct = v.getUint8(4);
      btnBatt.textContent = "ðŸ”‹ " + battPct + "%";
    };
    e.currentTarget.classList.add("on");
    setStatus("Connected");
  } else {
    device.gatt.disconnect();
    e.currentTarget.classList.remove("on");
    setStatus("Disconnected");
  }
};
</script>
</body>
</html>
